# Spike: Broker Integration (IBKR Paper Trading)

**Objective:** Automatically execute trades generated by the AlphaOracle Portfolio Manager using an Interactive Brokers (IBKR) Paper Trading account directly from GitHub Actions.

## The Challenge with IBKR
Unlike modern, cloud-first brokers (like Alpaca), Interactive Brokers' API was not designed to be accessed purely via REST from a serverless environment like GitHub Actions.

To use the standard IB API (`ibapi` or `ib_insync`), you *must* have a running instance of **TWS (Trader Workstation)** or **IB Gateway** on the same machine (or network) as your code. These programs handle the encrypted connection to IBKR's servers.

### Why is this hard in GitHub Actions?
1. **Headless Execution:** TWS is a GUI application. IB Gateway is lighter, but still requires a headless X server (like `Xvfb`) to run in a Linux terminal.
2. **Two-Factor Authentication (2FA):** IBKR enforces 2FA on login. While you can sometimes bypass this for read-only API access on a live account, a fresh login sequence often requires a mobile app ping, which breaks unattended automation.

## Potential Solutions

### Option 1: The Client Portal Web API (REST)
IBKR offers a REST-like API (Client Portal Web API). 
*   **Pros:** It uses HTTP requests (GET/POST), which is perfect for Python scripts running in GitHub Actions.
*   **Cons:** You still have to run a local Java gateway (the "Client Portal API Gateway") on the machine making the requests. More importantly, the session expires every 24 hours, and re-authenticating requires a manual login step in a browser, defeating the purpose of a fully automated daily cron job.

### Option 2: Headless IB Gateway via Docker (The "Hardcore" Route)
There are community-maintained Docker images (e.g., `ibcore` or `voyz/ibeam`) that package IB Gateway, `Xvfb`, and scripts to automatically handle the login.
*   **Pros:** True automation. Once set up, your Python script connects to this container.
*   **Cons:** Extremely complex to set up securely inside a GitHub Action runner. Managing the 2FA handshake in a remote, ephemeral container is brittle and prone to breaking.

### Option 3: Pivot to Alpaca for Automated Execution (Recommended Alternative)
If the goal is pure, cloud-hosted automation from GitHub Actions, **Alpaca** is the industry standard.
*   **Pros:** Native REST API. Uses simple API Keys (Key ID and Secret). No gateways, no GUI, no 2FA hurdles for the API connection. Generous free paper trading account. Excellent Python library (`alpaca-trade-api`).
*   **Cons:** It's not IBKR. The asset universe might be slightly more limited (though it covers all major US equities and ETFs, but limited international/options compared to IBKR).

### Option 4: The "Semi-Automated" IBKR Approach (The Pragmatic MVP)
Instead of forcing GitHub Actions to execute the trade, we use the system to generate a standardized order file.
1. GitHub Action runs the LLMs.
2. The PM LLM outputs a highly structured JSON or CSV file containing the exact orders (Ticker, Action, Quantity, Limit Price).
3. **Execution:** We run a very simple, lightweight Python script *locally* on our laptop (where TWS/IB Gateway is already running and authenticated) that reads the JSON from GitHub and executes the trades via `ib_insync`.

## Security: Managing API Keys
Regardless of the broker, **NEVER commit API keys or passwords to the repository.**

1.  **Local Development:** We use a `.env` file (which is ignored by `.gitignore`). The Python script loads these using `python-dotenv`.
2.  **GitHub Actions:** We use **GitHub Secrets**. 
    *   Go to Repository -> Settings -> Secrets and variables -> Actions.
    *   Create a New Repository Secret (e.g., `GEMINI_API_KEY`, `IBKR_ACCOUNT`).
    *   In the `.github/workflows/daily_analysis.yml` file, we map the secret to an environment variable so the Python script can read it:
    ```yaml
    - name: Run LLM Agents
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python src/llm_agents.py
    ```

## Recommendation
Attempting to run a fully automated IBKR Gateway inside a GitHub Action is generally discouraged due to instability and security complexity. 

**Immediate Next Step:** Let's implement the `python-dotenv` setup in our code to securely load the LLM keys first. If you absolutely need automated paper trading execution *today*, I highly recommend opening an Alpaca Paper account. If you strictly want IBKR, we should pursue **Option 4** (running the execution script locally based on the cloud's recommendations).